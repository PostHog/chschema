CREATE VIEW default.persons_batch_export AS WITH new_persons AS (SELECT id, max(version) AS version, argMax(_timestamp, person.version) AS _timestamp2 FROM default.person WHERE (team_id = {team_id:Int64}) AND (id IN (SELECT id FROM default.person WHERE (team_id = {team_id:Int64}) AND (_timestamp >= {interval_start:DateTime64}) AND (_timestamp < {interval_end:DateTime64}))) GROUP BY id HAVING (_timestamp2 >= {interval_start:DateTime64}) AND (_timestamp2 < {interval_end:DateTime64})), new_distinct_ids AS (SELECT argMax(person_id, person_distinct_id2.version) AS person_id FROM default.person_distinct_id2 WHERE (team_id = {team_id:Int64}) AND (distinct_id IN (SELECT distinct_id FROM default.person_distinct_id2 WHERE (team_id = {team_id:Int64}) AND (_timestamp >= {interval_start:DateTime64}) AND (_timestamp < {interval_end:DateTime64}))) GROUP BY distinct_id HAVING (argMax(_timestamp, person_distinct_id2.version) >= {interval_start:DateTime64}) AND (argMax(_timestamp, person_distinct_id2.version) < {interval_end:DateTime64})), all_new_persons AS (SELECT id, version FROM new_persons UNION ALL SELECT id, max(version) FROM default.person WHERE (team_id = {team_id:Int64}) AND (id IN (new_distinct_ids)) GROUP BY id) SELECT p.team_id AS team_id, pd.distinct_id AS distinct_id, toString(p.id) AS person_id, p.properties AS properties, pd.version AS person_distinct_id_version, p.version AS person_version, p.created_at AS created_at, multiIf(((pd._timestamp >= {interval_start:DateTime64}) AND (pd._timestamp < {interval_end:DateTime64})) AND (NOT ((p._timestamp >= {interval_start:DateTime64}) AND (p._timestamp < {interval_end:DateTime64}))), pd._timestamp, ((p._timestamp >= {interval_start:DateTime64}) AND (p._timestamp < {interval_end:DateTime64})) AND (NOT ((pd._timestamp >= {interval_start:DateTime64}) AND (pd._timestamp < {interval_end:DateTime64}))), p._timestamp, least(p._timestamp, pd._timestamp)) AS _inserted_at FROM default.person AS p INNER JOIN (SELECT distinct_id, max(version) AS version, argMax(person_id, person_distinct_id2.version) AS person_id2, argMax(_timestamp, person_distinct_id2.version) AS _timestamp FROM default.person_distinct_id2 WHERE (team_id = {team_id:Int64}) AND (person_id IN (SELECT id FROM all_new_persons)) GROUP BY distinct_id) AS pd ON p.id = pd.person_id2 WHERE (team_id = {team_id:Int64}) AND ((id, version) IN (all_new_persons)) ORDER BY _inserted_at ASC